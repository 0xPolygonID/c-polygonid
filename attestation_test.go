package c_polygonid

import (
	"context"
	"encoding/json"
	"testing"
	"testing/synctest"
	"time"

	"github.com/stretchr/testify/require"
)

func sleepTill(tm string) {
	tmParsed, err := time.Parse(time.RFC3339, tm)
	if err != nil {
		panic(err)
	}
	wait := time.Until(tmParsed)
	if wait < 0 {
		wait = 0
	}
	time.Sleep(wait)
}

func TestAttestationKMSOk(t *testing.T) {
	req := `{
  "attestation_document": "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"
}`
	synctest.Run(func() {
		sleepTill("2025-05-28T10:00:00Z")

		ctx := context.Background()
		cfg := EnvConfig{}
		resp, err := ValidateAttestationDocument(ctx, cfg, []byte(req))
		require.NoError(t, err)
		respBytes, err := json.Marshal(resp)
		require.NoError(t, err)

		wantResp := `{
  "public_key":"f6a7b446603c646f637bf76c64d9cadf305ebac61d9b4a0a0c5719f554fc3e4a"
}`
		require.JSONEq(t, wantResp, string(respBytes))
		//t.Log(string(respBytes))
	})
}

func TestAttestationNotOK(t *testing.T) {
	req := `{
  "attestation_document": "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FfZhOpN3p3dqVWeg/tuvZTXMLaVZAsQwggLAMIICRaADAgECAhUAwlAmiSbVzRac3J294u7As883UsAwCgYIKoZIzj0EAwMwgYkxPDA6BgNVBAMMM2JhZDgwZWZlMDM2ODc2NWUuem9uYWwuZXUtd2VzdC0xLmF3cy5uaXRyby1lbmNsYXZlczEMMAoGA1UECwwDQVdTMQ8wDQYDVQQKDAZBbWF6b24xCzAJBgNVBAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTAeFw0yNTA1MTQwMDIyMjRaFw0yNTA1MTUwMDIyMjRaMIGOMQswCQYDVQQGEwJVUzETMBEGA1UECAwKV2FzaGluZ3RvbjEQMA4GA1UEBwwHU2VhdHRsZTEPMA0GA1UECgwGQW1hem9uMQwwCgYDVQQLDANBV1MxOTA3BgNVBAMMMGktMDlkMTQ4MTM5YzYyYzM0ZjEuZXUtd2VzdC0xLmF3cy5uaXRyby1lbmNsYXZlczB2MBAGByqGSM49AgEGBSuBBAAiA2IABDVUU+o2ghj2oFViRKYITQo1jYg8n6AKTZiuOUpX7wUiCrombyicNzOUR/C9G4PyY8ykBVXSmfBCxYQg/XL4YohymLWkmP+sh9gnIr0xg4dptwqxs8r/uzBAbS7Bj3oqDKNmMGQwEgYDVR0TAQH/BAgwBgEB/wIBADAOBgNVHQ8BAf8EBAMCAgQwHQYDVR0OBBYEFDGi3ChWJydRfSMbFn9Zv6IVYDHJMB8GA1UdIwQYMBaAFBsrMX+Xf+oufGGZpmryHe5Mtw4KMAoGCCqGSM49BAMDA2kAMGYCMQDJy0A1DthhV4TZWlSruya9LIlBXDgiASh+OVitCDeJd49s1EvrkhzXRfub5zVGYcMCMQCHXfn8EVwhFZ0Vwv036jI29kGBUx1WzaOEVNc1G+vNrcfLga8a5r847U9zMu5ZAb1qcHVibGljX2tlefZpdXNlcl9kYXRhWQGVeyJrdHkiOiJSU0EiLCJuIjoiMlZVRHM1ZE1sNENkZjRtOUV4NFZBbkwza1c2dkN3d2Zsa2dTeUVkUU00UGFOY25pMmRWaWk1V0lVUjJMNU9JQjRTQkhGVkpiTTFkNlZRemhPcDRMUmpPa1dDclBkaGF3al9MUjJOZFhpWHhrX2lKZlBhekZWZzg1UmFHTWxmQVhwdVNmMHU4UVZuZkJFemlNWFhKdldPMGdoM043clMzaWQ3aWlzbzk1dE9kalFKMlRNTlFfTjBlWVFyaDlQZ2xLTE81UDFjX25jT1FsSmtPM1dwSnQ3cnU1SURjbVBFbTAxT3JPczdQbnRmM0h2RGozX19oeUhiMEFJZG1OUjBHM2VkOThKNS1iNjRaaXZRM1QwTy1LTEtMbUlQekVGek0tQ2FudHN1Si1nMmpYUlVmUkloemVFTDBHV1NWZ2dtN3Ixeld1eHFPaFR1ajJDcVB6UkFSM3JRIiwiZSI6IkFRQUIiLCJhbGciOiJSU0EtT0FFUC0yNTYiLCJleHQiOnRydWV9ZW5vbmNlWCB6TOzEkeAF1SmZE2fkUhSafsCszbai8jCINwUGd5DxClhg4OFcNMKArH1ftGuiHaJ8zSE06b4VAOmv46m08M+aL24BWQxoX08FrXAgV1KclaLyUgyugc34F/luoR+OMsokVY6XTyc4BObnFxLLjF6kMGcMZlr/OFwDgKw+umZhirSa"
}`
	synctest.Run(func() {
		sleepTill("2025-12-25T10:00:00Z")

		ctx := context.Background()
		cfg := EnvConfig{}
		_, err := ValidateAttestationDocument(ctx, cfg, []byte(req))
		require.ErrorContains(t, err,
			`failed to verify attestation certificate chain: x509: certificate has expired or is not yet valid: current time`)
	})
}

func TestAttestationTEEEnc(t *testing.T) {
	req := `{
  "attestation_document": "hEShATgioFkSt6lpbW9kdWxlX2lkeCdpLTA5ZDE0ODEzOWM2MmMzNGYxLWVuYzAxOTZjZGJiYjczZjZkNDVmZGlnZXN0ZlNIQTM4NGl0aW1lc3RhbXAbAAABls2+yHBkcGNyc7AAWDDFl25izzLCeS0nGxGDZZ0DJJ3cO1YhxBytXJpjC40ASoUTI84dwDDn/BtDbY6kjSEBWDBLTVs2YbPvwSkgkAyA4Sbkzng8Ui3mwCoqW/evOiuTJ7hndvGI5L4cHEBKEp29pJMCWDCgHDHqYI1OvKtzyp7Bv3YXxPZTTP7umyPt7KpVGzhzzESqPWJEH7m1CcvDeBdb+uYDWDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEWDDoCgKkpYpVtfgAp7Y87oi+I2ZrSFzEVyzwNwroerk7XX+TvrO3woMoWmlRBtHUFtkFWDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGWDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHWDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIWDBMmVoZyH0EoIuUp9q/Q7my0DSNP+J1/YAg+lk2/UGufOndmNuwSDkhrrlosYTPQGsJWDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKWDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALWDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMWDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANWDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOWDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPWDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABrY2VydGlmaWNhdGVZAn8wggJ7MIICAaADAgECAhABls27tz9tRQAAAABoJEjCMAoGCCqGSM49BAMDMIGOMQswCQYDVQQGEwJVUzETMBEGA1UECAwKV2FzaGluZ3RvbjEQMA4GA1UEBwwHU2VhdHRsZTEPMA0GA1UECgwGQW1hem9uMQwwCgYDVQQLDANBV1MxOTA3BgNVBAMMMGktMDlkMTQ4MTM5YzYyYzM0ZjEuZXUtd2VzdC0xLmF3cy5uaXRyby1lbmNsYXZlczAeFw0yNTA1MTQwNzM5NDNaFw0yNTA1MTQxMDM5NDZaMIGTMQswCQYDVQQGEwJVUzETMBEGA1UECAwKV2FzaGluZ3RvbjEQMA4GA1UEBwwHU2VhdHRsZTEPMA0GA1UECgwGQW1hem9uMQwwCgYDVQQLDANBV1MxPjA8BgNVBAMMNWktMDlkMTQ4MTM5YzYyYzM0ZjEtZW5jMDE5NmNkYmJiNzNmNmQ0NS5ldS13ZXN0LTEuYXdzMHYwEAYHKoZIzj0CAQYFK4EEACIDYgAEY/s7mRnYExsmS0VFugI5HfrWl5kdKY+YeBzggGjjWLPhk2QCSM1Z7golL5cuSW6XaQXsxcrex+SBb6aWqWAGZq7OutuhcbsnXPwA4I8zAqlxbpyF4ErPM0409to8JeRuox0wGzAMBgNVHRMBAf8EAjAAMAsGA1UdDwQEAwIGwDAKBggqhkjOPQQDAwNoADBlAjEAk6cRMO2br3LhNiQRBTCa+P2eX7pREqHIDjiJCrI3mTYtIUSaTw7QgReojwfF0UW1AjAN+gD5ranGt7HFaJYt0cELjAcsDTQC+RZIhcxttOxKmWuayZQipaLTG5C5gjSN5kxoY2FidW5kbGWEWQIVMIICETCCAZagAwIBAgIRAPkxdWgbkK/hHUbMtOTn+FYwCgYIKoZIzj0EAwMwSTELMAkGA1UEBhMCVVMxDzANBgNVBAoMBkFtYXpvbjEMMAoGA1UECwwDQVdTMRswGQYDVQQDDBJhd3Mubml0cm8tZW5jbGF2ZXMwHhcNMTkxMDI4MTMyODA1WhcNNDkxMDI4MTQyODA1WjBJMQswCQYDVQQGEwJVUzEPMA0GA1UECgwGQW1hem9uMQwwCgYDVQQLDANBV1MxGzAZBgNVBAMMEmF3cy5uaXRyby1lbmNsYXZlczB2MBAGByqGSM49AgEGBSuBBAAiA2IABPwCVOumCMHzaHDimtqQvkY4MpJzbolL//Zy2YlES1BR5TSksfbb48C8WBoyt7F2Bw7eEtaaP+ohG2bnUs990d0JX28TcPQXCEPZ3BABIeTPYwEoCWZEh8l5YoQwTcU/9KNCMEAwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQUkCW1DdkFR+eWw5b6cp3PmanfS5YwDgYDVR0PAQH/BAQDAgGGMAoGCCqGSM49BAMDA2kAMGYCMQCjfy+Rocm9Xue4YnwWmNJVA44fA0P5W2OpYow9OYCVRaEevL8uO1XYru5xtMPWrfMCMQCi85sWBbJwKKXdS6BptQFuZbT73o/gBh1qUxl/nNr12UO8Yfwr6wPLb+6NIwLz3/ZZAsEwggK9MIICRKADAgECAhBjcz2CGLvh2LGysEaUSxnyMAoGCCqGSM49BAMDMEkxCzAJBgNVBAYTAlVTMQ8wDQYDVQQKDAZBbWF6b24xDDAKBgNVBAsMA0FXUzEbMBkGA1UEAwwSYXdzLm5pdHJvLWVuY2xhdmVzMB4XDTI1MDUxMTAyMjA1NVoXDTI1MDUzMTAzMjA1NVowZDELMAkGA1UEBhMCVVMxDzANBgNVBAoMBkFtYXpvbjEMMAoGA1UECwwDQVdTMTYwNAYDVQQDDC0xNTM3MzQzMDc3OTEzZDVhLmV1LXdlc3QtMS5hd3Mubml0cm8tZW5jbGF2ZXMwdjAQBgcqhkjOPQIBBgUrgQQAIgNiAARUzrQsUd1ieH+LoGnO5BPtaAquQ6A/nEIJycGmchFzhQZuMaVXFSiLyrhwF8Rs6Z4gxT3WmWa4aUHdhBMbTiC89csKqKTIsp4M/CvP3O8mFmavJ63496kWSxA8uP3gdmmjgdUwgdIwEgYDVR0TAQH/BAgwBgEB/wIBAjAfBgNVHSMEGDAWgBSQJbUN2QVH55bDlvpync+Zqd9LljAdBgNVHQ4EFgQUC5VcoCYHGJ7XDuGhJ03NuEKRZDEwDgYDVR0PAQH/BAQDAgGGMGwGA1UdHwRlMGMwYaBfoF2GW2h0dHA6Ly9hd3Mtbml0cm8tZW5jbGF2ZXMtY3JsLnMzLmFtYXpvbmF3cy5jb20vY3JsL2FiNDk2MGNjLTdkNjMtNDJiZC05ZTlmLTU5MzM4Y2I2N2Y4NC5jcmwwCgYIKoZIzj0EAwMDZwAwZAIwRobZ16ZHEWJMJgVs+BZv3Fs9RrfumebYD7jpt46HQgiESmcihiDbdnyyWP82ANxwAjAdDi6/Nh/9fOZS30hV3oM48OI0bADB1NOvpXguZ2gLyVnW1NQ0FNxIpEDkIDZEO9BZAxgwggMUMIICmqADAgECAhB7Q5wefCCnK04FguPFdL3MMAoGCCqGSM49BAMDMGQxCzAJBgNVBAYTAlVTMQ8wDQYDVQQKDAZBbWF6b24xDDAKBgNVBAsMA0FXUzE2MDQGA1UEAwwtMTUzNzM0MzA3NzkxM2Q1YS5ldS13ZXN0LTEuYXdzLm5pdHJvLWVuY2xhdmVzMB4XDTI1MDUxMzIyNTcwOFoXDTI1MDUxOTEyNTcwN1owgYkxPDA6BgNVBAMMM2JhZDgwZWZlMDM2ODc2NWUuem9uYWwuZXUtd2VzdC0xLmF3cy5uaXRyby1lbmNsYXZlczEMMAoGA1UECwwDQVdTMQ8wDQYDVQQKDAZBbWF6b24xCzAJBgNVBAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTB2MBAGByqGSM49AgEGBSuBBAAiA2IABBZWDONSJFIDBp7W4SFSsTOZaD6ko35tZ6tZMlaxacTQOw++Uev/J6Nwd9ZjavXeSFjpMIEjBw6qBF39rpxYAZqjCbl+k2jIa67uz7/BqeVcJNBqSly+AEoJ6gQYUk9lpqOB6jCB5zASBgNVHRMBAf8ECDAGAQH/AgEBMB8GA1UdIwQYMBaAFAuVXKAmBxie1w7hoSdNzbhCkWQxMB0GA1UdDgQWBBQbKzF/l3/qLnxhmaZq8h3uTLcOCjAOBgNVHQ8BAf8EBAMCAYYwgYAGA1UdHwR5MHcwdaBzoHGGb2h0dHA6Ly9jcmwtZXUtd2VzdC0xLWF3cy1uaXRyby1lbmNsYXZlcy5zMy5ldS13ZXN0LTEuYW1hem9uYXdzLmNvbS9jcmwvZWNkNGY5ZTctYjhhYy00MThlLWEwZDUtYzg1ZWU0NjhiNTg3LmNybDAKBggqhkjOPQQDAwNoADBlAjEA3jSyfRjAIdf59CPgPA1Zs+Bx7Fy1A4WdyWUsQQfR3y8L0k24Wbony/DY9jQmbChsAjBdbBJwEsFJDRpNybLLFQ6fcTgeDt9UvJ6UTGJWFfZhOpN3p3dqVWeg/tuvZTXMLaVZAsQwggLAMIICRaADAgECAhUAwlAmiSbVzRac3J294u7As883UsAwCgYIKoZIzj0EAwMwgYkxPDA6BgNVBAMMM2JhZDgwZWZlMDM2ODc2NWUuem9uYWwuZXUtd2VzdC0xLmF3cy5uaXRyby1lbmNsYXZlczEMMAoGA1UECwwDQVdTMQ8wDQYDVQQKDAZBbWF6b24xCzAJBgNVBAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTAeFw0yNTA1MTQwMDIyMjRaFw0yNTA1MTUwMDIyMjRaMIGOMQswCQYDVQQGEwJVUzETMBEGA1UECAwKV2FzaGluZ3RvbjEQMA4GA1UEBwwHU2VhdHRsZTEPMA0GA1UECgwGQW1hem9uMQwwCgYDVQQLDANBV1MxOTA3BgNVBAMMMGktMDlkMTQ4MTM5YzYyYzM0ZjEuZXUtd2VzdC0xLmF3cy5uaXRyby1lbmNsYXZlczB2MBAGByqGSM49AgEGBSuBBAAiA2IABDVUU+o2ghj2oFViRKYITQo1jYg8n6AKTZiuOUpX7wUiCrombyicNzOUR/C9G4PyY8ykBVXSmfBCxYQg/XL4YohymLWkmP+sh9gnIr0xg4dptwqxs8r/uzBAbS7Bj3oqDKNmMGQwEgYDVR0TAQH/BAgwBgEB/wIBADAOBgNVHQ8BAf8EBAMCAgQwHQYDVR0OBBYEFDGi3ChWJydRfSMbFn9Zv6IVYDHJMB8GA1UdIwQYMBaAFBsrMX+Xf+oufGGZpmryHe5Mtw4KMAoGCCqGSM49BAMDA2kAMGYCMQDJy0A1DthhV4TZWlSruya9LIlBXDgiASh+OVitCDeJd49s1EvrkhzXRfub5zVGYcMCMQCHXfn8EVwhFZ0Vwv036jI29kGBUx1WzaOEVNc1G+vNrcfLga8a5r847U9zMu5ZAb1qcHVibGljX2tlefZpdXNlcl9kYXRhWQGVeyJrdHkiOiJSU0EiLCJuIjoiMlZVRHM1ZE1sNENkZjRtOUV4NFZBbkwza1c2dkN3d2Zsa2dTeUVkUU00UGFOY25pMmRWaWk1V0lVUjJMNU9JQjRTQkhGVkpiTTFkNlZRemhPcDRMUmpPa1dDclBkaGF3al9MUjJOZFhpWHhrX2lKZlBhekZWZzg1UmFHTWxmQVhwdVNmMHU4UVZuZkJFemlNWFhKdldPMGdoM043clMzaWQ3aWlzbzk1dE9kalFKMlRNTlFfTjBlWVFyaDlQZ2xLTE81UDFjX25jT1FsSmtPM1dwSnQ3cnU1SURjbVBFbTAxT3JPczdQbnRmM0h2RGozX19oeUhiMEFJZG1OUjBHM2VkOThKNS1iNjRaaXZRM1QwTy1LTEtMbUlQekVGek0tQ2FudHN1Si1nMmpYUlVmUkloemVFTDBHV1NWZ2dtN3Ixeld1eHFPaFR1ajJDcVB6UkFSM3JRIiwiZSI6IkFRQUIiLCJhbGciOiJSU0EtT0FFUC0yNTYiLCJleHQiOnRydWV9ZW5vbmNlWCB6TOzEkeAF1SmZE2fkUhSafsCszbai8jCINwUGd5DxClhg4OFcNMKArH1ftGuiHaJ8zSE06b4VAOmv46m08M+aL24BWQxoX08FrXAgV1KclaLyUgyugc34F/luoR+OMsokVY6XTyc4BObnFxLLjF6kMGcMZlr/OFwDgKw+umZhirSa"
}`
	synctest.Run(func() {
		sleepTill("2025-05-14T10:30:00Z")

		ctx := context.Background()
		cfg := EnvConfig{}
		resp, err := ValidateAttestationDocument(ctx, cfg, []byte(req))
		require.NoError(t, err)
		respBytes, err := json.Marshal(resp)
		require.NoError(t, err)

		wantResp := `{
  "user_data":"eyJrdHkiOiJSU0EiLCJuIjoiMlZVRHM1ZE1sNENkZjRtOUV4NFZBbkwza1c2dkN3d2Zsa2dTeUVkUU00UGFOY25pMmRWaWk1V0lVUjJMNU9JQjRTQkhGVkpiTTFkNlZRemhPcDRMUmpPa1dDclBkaGF3al9MUjJOZFhpWHhrX2lKZlBhekZWZzg1UmFHTWxmQVhwdVNmMHU4UVZuZkJFemlNWFhKdldPMGdoM043clMzaWQ3aWlzbzk1dE9kalFKMlRNTlFfTjBlWVFyaDlQZ2xLTE81UDFjX25jT1FsSmtPM1dwSnQ3cnU1SURjbVBFbTAxT3JPczdQbnRmM0h2RGozX19oeUhiMEFJZG1OUjBHM2VkOThKNS1iNjRaaXZRM1QwTy1LTEtMbUlQekVGek0tQ2FudHN1Si1nMmpYUlVmUkloemVFTDBHV1NWZ2dtN3Ixeld1eHFPaFR1ajJDcVB6UkFSM3JRIiwiZSI6IkFRQUIiLCJhbGciOiJSU0EtT0FFUC0yNTYiLCJleHQiOnRydWV9"
}`
		require.JSONEq(t, wantResp, string(respBytes))
	})
}

func TestAttestationTEESig(t *testing.T) {
	req := `{
  "attestation_document": "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"
}`
	synctest.Run(func() {
		sleepTill("2025-05-14T10:30:00Z")

		ctx := context.Background()
		cfg := EnvConfig{}
		resp, err := ValidateAttestationDocument(ctx, cfg, []byte(req))
		require.NoError(t, err)
		respBytes, err := json.Marshal(resp)
		require.NoError(t, err)

		wantResp := `{
  "user_data":"cJl5cMUYEtw6AQx9AbUODRfcecg="
}`
		require.JSONEq(t, wantResp, string(respBytes))
	})
}
