package c_polygonid

import (
	"context"
	"encoding/json"
	"math/big"
	"os"
	"testing"

	gocircuitexternal "github.com/0xPolygonID/go-circuit-external/AnonAadhaar"
	"github.com/stretchr/testify/require"
)

func toBigInt(in string) *big.Int {
	i, ok := new(big.Int).SetString(in, 10)
	if !ok {
		panic(in)
	}
	return i
}

func TestAnonAadhaarV1Inputs_UnmarshalJSON(t *testing.T) {
	d, err := os.ReadFile("testdata/anon_aadhaar_v1_inputs.json")
	require.NoError(t, err)

	var inputs anonAadhaarV1Inputs
	err = json.Unmarshal(d, &inputs)
	require.NoError(t, err)

	want := &gocircuitexternal.AnonAadhaarV1Inputs{
		QRData:                          toBigInt("8259163575998395410294216884136380576185817320339145460288951755287582961380611852552428987321584902318624273479337130653734982789439199350807739714406680256506601030028361685736660257517232716829232450159251789263870750283214820475102793105777087762238893090228084052270739203426767272062178826235941508196284529472654271516164224874687419158221021213944829682919423174703783469927383220474654008065915029614141226522064062660593170425792840873655513538373377850112144063189928583588899889878172757870400281696669604010659786496608127700010264443115263361656744433002559396889060190428705316366290450741550935385486607346514118464415324976934593027192262025619948063647667007927187736245772179085671658409804311603784752615097922989017361163561315974008304022542448394278143245816470881130080719485003834016131185071765229491892891069788319670287394271744730364788949609836924781874523936880888005883165757273872375006288978183466996520618718348187182821516617721340861010989807614756396013627238651856164981477576514065364628430139194213240602981419233621531616776712580234318576148789862972873366521755587675635811636464535551028275057950562020714225333126426609311459495088802145911084644641596208432517247324679678535859879970296810837735288916946197174410518342751033634782712968162882714769666441813893046220965525694847349131353986974388432968669605721975441870936552792275255624723251162192468002453471184713983574359601113515796454264270501379717344206777921353459767049560942843350534472442799601294637063232419543855742825887931841338302499933012059977947394755335155868283405337181095220998277373266658634859632929226320059674299759100792654417315629048732480315019941928105082550091217622422743467170706956093632228513797781797454779203616427853022505097310749994766657051986303478622173767936568165644251615127773430128638507677775244195799780291921828512257290767451475181728141544788756907393883042588060697683541401090581157249784874529424005078918452607589129440476242749110421616270676359722523229311894327359615548588038186027827017569331332262329182564217789843145105509621002324556840213928256545454178891208004109769624959566302976213521762873815749009289995208912424872527724417047936432945498377307452190302923489092664437908497749093491199476080757200233878726847198496754472664256996743796092233459542884818717466621372105594672115988382565552756801323160697003960485232732393383241422077506009076922303757067128564302338914230360252223406874457414109774901980252709597099278192874164252010830754720603092419792069707099362278082792090307065378744856387301364608460967253691290230861162587170799141457093188189022390589265654613500974699477990974878105678883229707694455342266695530373994049224098435972125150350136428446936271698977517627416435999970351222450833295217051468307037908262231982382247410542334757724852032521780157518474618653527191342825230455100778913195115477763082159513429761573752871477695723697689470263993132596482716347199834315782099668846081963760553679915994617396376870314998926788197388410764535427795200340714967872713095483294486407886767431404892448155562283436571050452251042117926586451385682519188252281397"),
		CredentialSubjectID:             "did:iden3:privado:main:2Scn2RfosbkQDMQzQM5nCz3Nk5GnbzZCWzGCd3tc2G",
		CredentialStatusRevocationNonce: 1257894000,
		CredentialStatusID:              "did:iden3:privado:main:2Si3eZUE6XetYsmU5dyUK2Cvaxr1EEe65vdv2BML4L/credentialStatus?revocationNonce=1257894000&contractAddress=80001:0x2fCE183c7Fbc4EbB5DB3B0F5a63e0e02AE9a85d2",
		IssuerID:                        "did:iden3:privado:main:2Si3eZUE6XetYsmU5dyUK2Cvaxr1EEe65vdv2BML4L",
		PubKey: `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAlegfdQZZXMJirdz93TXY
BAVbKt9G3HGcVrWO7hmZle+hoyVHEGIKx4Ael29E475FTbDxkOP31ONZiXIRc0Te
Uvz3gm+ElIipWaez0h623QNFFmLqiD7u796ImhSZuaR/lQTF8JbCYrltI9GXUDMt
npfrYUHSYd6XmU1MQWPKnL4+B3IhtEJT3PgWCUKLaDUe4+m2DSs1H9qm7owoqEUj
n5fefMD+XRROR0gT+0PsWD+BtO4yjCIWczSJjSELoBeibsaJQPBd8ivZzIa7w6Q1
Q5I3LVZhZ3abc1uhLKNYD5GcG9i6cMTCqwrPKwm8L66YHzwClabh6fJI9QBzCU/6
8QIDAQAB
-----END PUBLIC KEY-----`,
		NullifierSeed: 12345678,
		SignalHash:    1001,
	}

	require.Equal(t, want, inputs.asAnonAadhaarV1Inputs())
}

func TestIsValidAadhaarQR(t *testing.T) {
	d, err := os.ReadFile("testdata/anon_aadhaar_valid_qr.json")
	require.NoError(t, err)
	r, err := VerifyAnonAadhaarQR(context.Background(), EnvConfig{}, d)
	require.NoError(t, err)
	require.True(t, r.IsValid)
}

func TestIsValidAadhaarQR_Error(t *testing.T) {
	tests := []struct {
		name        string
		inputFile   string
		expectedErr error
	}{
		{
			name:        "Invalid QR. Not a Aadhaar QR",
			inputFile:   "testdata/anon_aadhaar_invalid_qr.json",
			expectedErr: gocircuitexternal.ErrInvalidQRData, // str: invalid QR data
		},
		{
			name:        "Invalid QR version. Not supported version",
			inputFile:   "testdata/anon_aadhaar_invalid_qr_version.json",
			expectedErr: gocircuitexternal.ErrInvalidQRVersion, // str: invalid QR version
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			d, err := os.ReadFile(tt.inputFile)
			require.NoError(t, err)
			r, err := VerifyAnonAadhaarQR(context.Background(), EnvConfig{}, d)
			require.ErrorIs(t, err, tt.expectedErr)
			require.False(t, r.IsValid)
		})
	}
}
